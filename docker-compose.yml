version: '3.8'

services:
  # === 数据库服务 ===
  db:
    image: postgres:15-alpine
    container_name: meeting_db
    restart: always
    volumes:
      - ./pgdata:/var/lib/postgresql/data
    environment:
      - POSTGRES_USER=paperless
      - POSTGRES_PASSWORD=123456 # <--- 请务必修改此密码
      - POSTGRES_DB=paperless_meeting
      - TZ=Asia/Shanghai

  # === Redis 服务 (用于 Socket.IO 多 Worker 支持) ===
  redis:
    image: redis:7-alpine
    container_name: meeting_redis
    restart: always
    environment:
      - TZ=Asia/Shanghai

  # === 后端服务 ===
  backend:
    build: ./backend
    container_name: meeting_backend
    restart: always
    command: [ "/bin/bash", "./run_production.sh" ] # 使用 Gunicorn 生产启动
    volumes:
      - ./backend/uploads:/app/uploads
      # 如果需要保留 SQLite 作为备份，可以取消注释下面这行
      # - ./backend/database.db:/app/database.db
    depends_on:
      - db
      - redis
    environment:
      - TZ=Asia/Shanghai
      # 连接到名为 'db' 的服务
      - DATABASE_URL=postgresql://paperless:123456@db:5432/paperless_meeting
      # Redis 连接 (用于 Socket.IO 跨 Worker 通信)
      - REDIS_URL=redis://redis:6379

  # === 前端服务 ===
  frontend:
    build: ./frontend
    container_name: meeting_frontend
    restart: always
    ports:
      # 【重要】这里将容器的 80 映射到 VPS 的 5000 端口
      # 这样 VPS 的 Nginx 就可以把 coso.top 转发到 localhost:5000
      - "5000:80"
    depends_on:
      - backend
    environment:
      - TZ=Asia/Shanghai
