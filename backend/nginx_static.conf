# ============================================================
# Nginx 配置示例 - 高并发优化
# ============================================================
# 此配置实现动静分离:
# - API 请求转发给 FastAPI (Python)
# - 静态文件 (PDF, 图片) 由 Nginx 直接处理，不经过 Python
# 
# 使用方法:
# 1. 将此文件复制到 /etc/nginx/conf.d/paperless_meeting.conf
# 2. 修改 server_name 和 root 路径
# 3. 执行 nginx -t 检查语法
# 4. 执行 systemctl reload nginx 重载配置
# ============================================================

server {
    listen 80;
    server_name your_server_ip;  # 修改为实际域名或IP

    # 客户端文件上传大小限制 (会议附件可能较大)
    client_max_body_size 100M;

    # =====================================================
    # 1. API 请求 - 转发给 FastAPI (Python)
    # =====================================================
    location /api/ {
        proxy_pass http://127.0.0.1:8000/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 超时配置 (防止长请求被断开)
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # =====================================================
    # 2. 静态文件 - 由 Nginx 直接处理 (核心优化点)
    # =====================================================
    # 路径需要与 FastAPI 的 /static 路由一致
    location /static/ {
        alias /path/to/paperless_meeting/backend/uploads/;  # 修改为实际路径
        
        # 浏览器缓存 30 天
        expires 30d;
        add_header Cache-Control "public, immutable";
        
        # 高效文件传输
        sendfile on;
        tcp_nopush on;
        tcp_nodelay on;
        
        # CORS 头 (如果安卓端需要直接访问)
        add_header Access-Control-Allow-Origin *;
    }

    # =====================================================
    # 3. 前端静态资源 (如果前端也部署在同一服务器)
    # =====================================================
    location / {
        root /path/to/paperless_meeting/frontend/dist;  # 修改为实际路径
        try_files $uri $uri/ /index.html;
        
        # 静态资源缓存
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2)$ {
            expires 7d;
            add_header Cache-Control "public";
        }
    }
}
