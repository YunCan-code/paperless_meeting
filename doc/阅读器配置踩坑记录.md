# Android PDF 阅读器配置踩坑记录

> **摘要**：本文记录了在 Paperless Meeting 项目中集成 PDF 阅读器功能的完整过程。从原生实现到第三方库的反复尝试，最终通过升级编译环境和切换维护分支解决了一系列依赖冲突和构建错误。

## 1. 初始尝试：原生 PdfRenderer
最开始为了追求轻量化，尝试使用 Android 原生的 `PdfRenderer` 结合 Jetpack Compose 的 `Image` 组件自行实现。

- **实现方式**：
  - 使用 `ParcelFileDescriptor` 打开文件。
  - `PdfRenderer.openPage(index)` 获取页面。
  - 创建 `Bitmap` 并将页面内容渲染上去。
- **遇到的坑**：
  1.  **黑屏问题**：渲染出的 Bitmap 默认背景是透明的，在黑色背景下看起来像黑屏。
      - *解决*：`bitmap.eraseColor(Color.WHITE)` 强制填充白底。
  2.  **宽高比失真**：直接使用屏幕宽高创建 Bitmap，导致 PDF 内容被强行拉伸或压扁。
      - *解决*：根据 PDF 页面的原始宽高比计算缩放系数 (`scale`)，动态计算 Bitmap 尺寸。
- **放弃原因**：虽然能看，但缺乏手势缩放、惯性滑动等高级交互，从头造轮子成本过高。

## 2. 尝试二：Bouquet (Compose 专用库)
为了获得更好的 Compose 体验，尝试引入 `io.github.grizzi91:bouquet`。

- **遇到的坑**：
  1.  **依赖下载失败**：Gradle Sync 一直无法通过，提示找不到库。
  2.  **导包错误**：代码中无法解析 `com.rizzi.bouquet` 或 `io.github.grizzi91.bouquet`。
- **原因分析**：国内直连 MavenCentral 网络不稳定，且项目初期未配置国内镜像源。

## 3. 尝试三：AndroidPdfViewer (版本 2.8.2)
转投经典的 `com.github.barteksc:android-pdf-viewer`，这是一个久经考验的 View 体系库，我们通过 `AndroidView` 桥接到 Compose。

- **遇到的坑**：
  - **构建失败 (Duplicate Class)**：
    ```text
    Duplicate class android.support.v4.app.AppLaunchChecker found in modules support-compat-28.0.0.aar ...
    ```
- **核心原因**：`2.8.2` 版本发布年代久远，内部依赖了旧版的 `android.support` 库。而我们的项目是纯 `AndroidX` 架构 (CompileSdk 34)，两者发生严重冲突。Jetifier 虽然能转换一部分，但在复杂依赖下依然失效。

## 4. 尝试四：升级与环境大修 (最终成功)
为了解决兼容性问题，我们进行了一系列激进的升级。

### 4.1 切换维护分支
原作者 `barteksc` 的库更新较慢，我们切换到了社区维护较好的分支（支持 AndroidX）：
- **旧**：`com.github.barteksc:android-pdf-viewer:2.8.2` (不支持 AndroidX)
- **旧**：`com.github.barteksc:AndroidPdfViewer:3.2.0-beta.1` (JitPack 路径大小写敏感坑)
- **新**：`com.github.asadwaheed1:AndroidPdfViewer:v3.2.0-beta06` (完美支持 AndroidX)

### 4.2 网络环境优化
修改 `settings.gradle.kts`，全面接入阿里云镜像，解决“下不动”的问题：
```kotlin
repositories {
    maven { url = uri("https://maven.aliyun.com/repository/public") }
    maven { url = uri("https://maven.aliyun.com/repository/google") }
    maven { url = uri("https://jitpack.io") }
}
```

### 4.3 编译环境升级 (关键一步)
最新的依赖库（尤其是 `androidx.core`）要求更高的编译版本。我们遇到了 `Manifest merger failed`，通过以下操作解决：

1.  **升级 CompileSdk**：
    在 `app/build.gradle.kts` 中：
    ```kotlin
    android {
        compileSdk = 35 // 从 34 升级到 35
    }
    ```
2.  **升级 AGP (Android Gradle Plugin)**：
    在 `libs.versions.toml` 中：
    ```toml
    agp = "8.6.0" // 从 8.5.1 升级
    ```

## 5. 最终成果
经过上述折腾，我们现在拥有了一个：
- **功能完备**：支持双指缩放、页面吸附、页码显示。
- **架构现代**：兼容 AndroidX，基于最新 SDK 编译。
- **网络稳健**：配置了国内镜像源。
的 PDF 阅读器模块。
