# 项目更新部署指南 (VPS)

本文档仅包含 **更新现有部署** 的步骤。假设你的项目位于 `/opt/paperless_meeting`。

## 1. 停止旧服务
在更新代码前，先停止正在运行的 Docker 容器。

```bash
cd /opt/paperless_meeting
docker compose down
```

## 2. 上传新代码
将本地最新的项目代码上传到 VPS，覆盖 `/opt/paperless_meeting` 目录下的内容。
**注意**: 请勿覆盖或删除 `backend/database.db` (如果它是实际生产数据库) 以及 `backend/static/` 下的用户上传文件，除非你确定要重置数据。

建议仅上传以下变动的文件夹/文件：
- `backend/` (排除 database.db, uploads, static)
- `frontend/`
- `docker-compose.yml`

## 3. 数据库与配置更新 (关键)

### 3.1 数据库迁移 (如果使用 SQLite)
如果你的 `backend/database.db` 是从旧版本保留下来的，需要执行迁移脚本以更新表结构。

```bash
# 进入容器执行迁移脚本
docker exec -it meeting_backend python migration_add_type_image.py
```

### 3.2 切换到 PostgreSQL (生产环境推荐 - 容器化部署)
对于 VPS 环境，**最简单的方法是使用 Docker 运行 PostgreSQL**，无需在 VPS 系统上安装数据库。

请直接使用以下 `docker-compose.yml` 替换原文件（注意修改 `POSTGRES_PASSWORD`）：

```yaml
version: '3.8'

services:
  # === 数据库服务 ===
  db:
    image: postgres:15-alpine
    restart: always
    volumes:
      - ./pgdata:/var/lib/postgresql/data
    environment:
      - POSTGRES_USER=paperless
      - POSTGRES_PASSWORD=secure_password_here  # <--- 请修改此密码
      - POSTGRES_DB=paperless_meeting
      - TZ=Asia/Shanghai

  # === 后端服务 ===
  backend:
    build: ./backend
    container_name: meeting_backend
    restart: always
    command: ["/bin/bash", "./run_production.sh"] # 使用 Gunicorn 生产启动
    volumes:
      - ./backend/uploads:/app/uploads
    depends_on:
      - db
    environment:
      - TZ=Asia/Shanghai
      # 连接到名为 'db' 的服务，使用上面设置的密码
      - DATABASE_URL=postgresql://paperless:secure_password_here@db:5432/paperless_meeting

  # === 前端服务 ===
  frontend:
    build: ./frontend
    container_name: meeting_frontend
    restart: always
    ports:
      - "5000:80"
    depends_on:
      - backend
    environment:
      - TZ=Asia/Shanghai
```

**更新步骤：**
1. 创建数据目录：`mkdir -p pgdata`
2. 更新 `docker-compose.yml` 内容。
3. 执行 `docker compose up -d --build`。
4. 数据库会自动初始化，无需手动建表（后端会自动执行）。

### 3.3 使用生产环境启动脚本
默认的 `docker-compose` 使用 `uvicorn` 直接启动，适合开发。生产环境建议使用我们新提供的 `run_production.sh` (基于 Gunicorn)。

修改 `docker-compose.yml` 中的启动命令：

```yaml
services:
  backend:
    # ... 其他配置 ...
    # 覆盖 Dockerfile 默认的 CMD
    command: ["/bin/bash", "./run_production.sh"]
```

## 4. 重新构建并启动
修改完配置后，重新构建镜像并启动服务。

```bash
cd /opt/paperless_meeting

```bash
# 重新构建镜像并后台启动
# --build 参数确保使用最新的代码重新编译
docker compose up -d --build
```

## 5. 数据初始化 (可选)
如果需要生成模拟数据（用户、会议类型、会议记录等），可以在容器启动后执行以下命令：

```bash
docker exec -it meeting_backend python populate_data.py
```

## 6. 验证更新
等待几十秒启动完成后，查看日志确认无报错：

```bash
docker compose logs -f
```

访问 https://coso.top 检查新功能是否生效。

---
**附：常用维护命令**

- **查看实时日志**: `docker compose logs -f`
- **重启服务 (不重修)**: `docker compose restart`
- **进入后端容器**: `docker exec -it meeting_backend /bin/bash`