# 项目更新部署指南 (VPS)

本文档仅包含 **更新现有部署** 的步骤。假设你的项目位于 `/opt/paperless_meeting`。

## 1. 停止旧服务
在更新代码前，先停止正在运行的 Docker 容器。

```bash
cd /opt/paperless_meeting
docker compose down
```

## 2. 上传新代码
将本地最新的项目代码上传到 VPS，覆盖 `/opt/paperless_meeting` 目录下的内容。
**注意**: 请勿覆盖或删除 `backend/database.db` (如果它是实际生产数据库) 以及 `backend/static/` 下的用户上传文件，除非你确定要重置数据。

建议仅上传以下变动的文件夹/文件：
- `backend/` (排除 database.db, uploads, static)
- `frontend/`
- `docker-compose.yml`

## 3. 数据库与配置更新 (关键)

### 3.1 数据库迁移 (如果使用 SQLite)
如果你的 `backend/database.db` 是从旧版本保留下来的，需要执行迁移脚本以更新表结构。

```bash
# 进入容器执行迁移脚本
docker exec -it meeting_backend python migration_add_type_image.py
```

### 3.2 切换到 PostgreSQL (生产环境推荐 - 容器化部署)
对于 VPS 环境，**最简单的方法是使用 Docker 运行 PostgreSQL**，无需在 VPS 系统上安装数据库。

请直接使用以下 `docker-compose.yml` 替换原文件（注意修改 `POSTGRES_PASSWORD`）：

```yaml
version: '3.8'

services:
  # === 数据库服务 ===
  db:
    image: postgres:15-alpine
    restart: always
    volumes:
      - ./pgdata:/var/lib/postgresql/data
    environment:
      - POSTGRES_USER=paperless
      - POSTGRES_PASSWORD=secure_password_here  # <--- 请修改此密码
      - POSTGRES_DB=paperless_meeting
      - TZ=Asia/Shanghai

  # === 后端服务 ===
  backend:
    build: ./backend
    container_name: meeting_backend
    restart: always
    command: ["/bin/bash", "./run_production.sh"] # 使用 Gunicorn 生产启动
    volumes:
      - ./backend/uploads:/app/uploads
    depends_on:
      - db
    environment:
      - TZ=Asia/Shanghai
      # 连接到名为 'db' 的服务，使用上面设置的密码
      - DATABASE_URL=postgresql://paperless:secure_password_here@db:5432/paperless_meeting

  # === 前端服务 ===
  frontend:
    build: ./frontend
    container_name: meeting_frontend
    restart: always
    ports:
      - "5000:80"
    depends_on:
      - backend
    environment:
      - TZ=Asia/Shanghai
```

**更新步骤：**
1. 创建数据目录：`mkdir -p pgdata`
2. 更新 `docker-compose.yml` 内容。
3. 执行 `docker compose up -d --build`。
4. 数据库会自动初始化，无需手动建表（后端会自动执行）。

### 3.3 使用生产环境启动脚本
默认的 `docker-compose` 使用 `uvicorn` 直接启动，适合开发。生产环境建议使用我们新提供的 `run_production.sh` (基于 Gunicorn)。

修改 `docker-compose.yml` 中的启动命令：

```yaml
services:
  backend:
    # ... 其他配置 ...
    # 覆盖 Dockerfile 默认的 CMD
    command: ["/bin/bash", "./run_production.sh"]
```

## 4. 重新构建并启动
修改完配置后，重新构建镜像并启动服务。

```bash
cd /opt/paperless_meeting

```bash
# 重新构建镜像并后台启动
# --build 参数确保使用最新的代码重新编译
docker compose up -d --build
```

## 5. 数据初始化 (可选)
如果需要生成模拟数据（用户、会议类型、会议记录等），可以在容器启动后执行以下命令：

```bash
docker exec -it meeting_backend python populate_data.py
```

## 6. 验证更新
等待几十秒启动完成后，查看日志确认无报错：

```bash
docker compose logs -f
```

访问 https://coso.top 检查新功能是否生效。

---
**附：常用维护命令**

- **查看实时日志**: `docker compose logs -f`
- **重启服务 (不重修)**: `docker compose restart`
- **进入后端容器**: `docker exec -it meeting_backend /bin/bash`

## 7. 常见问题 (Troubleshooting)

### 7.1 JavaScript heap out of memory (构建时内存溢出)

**现象**：
在执行 `docker compose up -d --build` 时，前端构建步骤报错：
```
FATAL ERROR: Ineffective mark-compacts near heap limit Allocation failed - JavaScript heap out of memory
npm error signal SIGABRT
```

**原因**：
服务器内存不足（通常发生在 1GB 或更低配置的 VPS 上），`vite build` 过程消耗内存超过了物理内存和 Swap 总和，或者 Node.js 未能正确利用现有 Swap。

**解决方案**：

**方法一：增加 Swap (推荐)**
如果你的 Swap 较小（如 1GB），建议增加到 4GB。
```bash
# 关闭现有 Swap
sudo swapoff -a
# 创建 4GB Swap 文件
sudo dd if=/dev/zero of=/swapfile bs=1M count=4096 status=progress
# 设置权限
sudo chmod 600 /swapfile
# 格式化
sudo mkswap /swapfile
# 启用
sudo swapon /swapfile
# 验证
free -h
```

**方法二：调整 Node.js 内存限制 (推荐)**
在 `frontend/Dockerfile` 中显式设置 Node.js 可使用的最大内存（强制利用 Swap），在 `COPY . .` 之后，`RUN npm run build` 之前添加：

```dockerfile
ENV NODE_OPTIONS="--max-old-space-size=4096"
```

**方法三：本地构建**

## 8. 进阶：使用 Git 进行增量更新 (推荐)

手动复制文件夹虽然直观，但容易出错且繁琐。推荐在 VPS 上配置 Git 来拉取更新。

### 8.1 首次配置 (初始化)

如果你的 VPS 上还没有 Git 仓库，可以将当前文件夹初始化为 Git 仓库并关联远程：

```bash
cd /opt/paperless_meeting

# 1. 初始化 Git
  git init

# 2. 添加远程仓库 (请替换为你的实际仓库地址)
git remote add origin https://github.com/YunCan-code/paperless_meeting.git

# 3. 拉取代码 (强制覆盖本地文件，慎用！)
# 注意：这会覆盖本地所有未提交的修改，请先备份重要配置文件(如 .env, docker-compose.yml)
git fetch --all
git reset --hard origin/main
```

### 8.2 日常更新流程

以后每次更新只需要执行以下命令：

```bash
cd /opt/paperless_meeting

# 1. 拉取最新代码
git pull origin main

# 2. 如果遇到冲突 (本地有修改)，可以选择覆盖本地：
# git reset --hard origin/main

# 3. 重新构建并启动 (如果修改了后端代码或依赖)
docker compose up -d --build backend

# 4. 如果修改了前端 (重新编译静态文件)
docker compose up -d --build frontend
```

### 8.3 常见 Git 问题

**Q: 每次都要输入密码？**
A: 配置 SSH Key 或使用 credential helper：
`git config --global credential.helper store` (下次输入一次密码后会记住)

**Q: `git pull` 提示冲突？**
A: 如果你修改了 VPS 上的文件（比如为了调试），Git 会阻止更新。
- 放弃本地修改：`git checkout .` (还原所有文件)
### 8.4 进阶：如何只拉取特定目录 (Sparse Checkout)

默认情况下 `git fetch` 会下载所有文件的历史，`git checkout` 会检出所有文件。如果你不想让 `android/` 或 `doc/` 目录占用 VPS 空间，可以使用 Sparse Checkout 功能。

**注意**：不同 Git 版本命令不同。CentOS 7 默认 Git 版本较老 (1.8.x)，请参考 8.4.2。

#### 8.4.1 Git 2.25+ (现代版)

```bash
# 1. 开启 sparse checkout
git sparse-checkout init --cone

# 2. 设置只保留的目录 (backend, frontend 和根目录文件)
git sparse-checkout set backend frontend 

# 3. 拉取更新
git pull origin main
```

#### 8.4.2 Git 1.8.x (CentOS 7 默认)

老版本没有 `sparse-checkout` 命令，需要手动配置：

```bash
# 1. 开启配置
git config core.sparsecheckout true

# 2. 写入规则到 .git/info/sparse-checkout
# 注意：根目录文件 (如 docker-compose.yml) 必须显式包含
echo "backend/" >> .git/info/sparse-checkout
echo "frontend/" >> .git/info/sparse-checkout
echo "docker-compose.yml" >> .git/info/sparse-checkout
echo "run_production.sh" >> .git/info/sparse-checkout
echo ".env" >> .git/info/sparse-checkout

# 3. 应用规则 (重新读取树)
git read-tree -m -u HEAD

# 4. 后续正常 pull 即可，Git 会自动忽略不在列表中的文件夹
git pull origin main
```
